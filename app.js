!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=31)}([function(e,t){e.exports=require("koa-router")},function(e,t,o){const n=o(16),r=o(15),s=o(3);t.getUuid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()},t.getResponse=function(e,t){return e?{data:t||{},success:!0}:{success:!1,error:t||"",errorMsg:n[t]||"未知错误！"}},t.LogFileArrange=(async()=>{r.scheduleJob({hour:0,minute:3},()=>{const e=s().format("YYYY-MM-DD-HH-mm");console.log("日志更新了"),fs.mkdir(`./logs/${e}`,()=>{["out","access","error"].map(t=>{const o=fs.createReadStream(`./logs/${t}.log`);let n="";o.setEncoding("UTF8"),o.on("data",e=>n+=e),o.on("end",()=>{let o=fs.createWriteStream(`./logs/${e}/${t}.log`);o.write(n,"UTF8"),o.end(),o.on("finish",()=>{(o=fs.createWriteStream(`./logs/${t}.log`)).write(""),o.end()})})})})})}),t.checkPhone=function(e){if(!e)return!1;return!!new RegExp(/^(13[0-9]|15[012356789]|17[0-9]|18[0-9]|14[57])[0-9]{8}$/).test(+e)},t.getAcessRealIP=(e=>e.headers["x-forwarded-for"]||e.connection.remoteAddress||e.socket.remoteAddress||e.connection.socket.remoteAddress),t.SessStoreUser=(async(e,t)=>{await t()})},function(e,t,o){e.exports=o(19)},function(e,t){e.exports=require("moment")},function(e,t){const o={name:"user",schema:{phone:String,openid:String,session_key:String,wx:{},create_time:{type:Number,default:Date.now},is_delete:{type:Boolean,default:!1}}};e.exports=o},function(e,t){const o={name:"article",schema:{user_id:String,title:String,content:String,images:[],voices:[],videos:[],create_time:{type:Number,default:Date.now}}};e.exports=o},function(e,t){const o={name:"log",schema:{sign_id:String,user_id:String,org_id:String,url:String,path:String,ip:String,params:{},opt:String,create_time:{default:Date.now,type:Number},hour:Number}};e.exports=o},function(e,t){e.exports=require("mongoose")},function(e,t,o){const n=o(7),{mongoUri:r,mongoUriParam:s}=o(2);n.Promise=global.Promise;const i=n.createConnection(`${r}/xlt?${s}`),a={},c=[o(6),o(5),o(4)];for(model of c){const e=new n.Schema("function"==typeof model.schema&&model.schema(n.Schema)||model.schema,{collection:model.name});a[model.name]=i.model(model.name,e)}e.exports=a},function(e,t){e.exports=require("urllib")},function(e,t,o){const{getResponse:n}=o(1),r=o(9),s=async e=>{const{body:t}=e.request,{code:o}=t;return new Promise(async e=>{await r.request(`https://api.weixin.qq.com/sns/jscode2session?appid=wxb77780bd66657b84&secret=5a1e4e7ea55504d7e8a70a2a9acedda7&js_code=${o}&grant_type=authorization_code`,async(t,o,n)=>{const{openid:r,session_key:s}=JSON.parse(o.toString());await models.user.findOne({openid:r,is_delete:!1})?await models.user.findOneAndUpdate({openid:r,is_delete:!1},{session_key:s}):await models.user.create({openid:r,session_key:s}),e(s)})})};e.exports={login:async e=>{const t=await s(e);e.body=n(!0,{session_key:t})},updateauth:async e=>{const{body:t}=e.request,{userInfo:o,session_key:r}=t;await models.user.findOneAndUpdate({session_key:r},{wx:o}),e.body=n(!0,"操作成功")}}},function(e,t,o){const n=o(0),r=o(10),s=n({prefix:"/api/auth"});s.post("/login",r.login),s.post("/updateauth",r.updateauth),e.exports=s},function(e,t,o){const{getResponse:n}=o(1),r=o(3);e.exports={list:async e=>{const{body:t}=e.request,{pageSize:o,pageNum:s}=t;let i=await models.article.find({},{title:1,content:1,create_time:1}).skip(+o*(+s-1)).limit(+o).sort({create_time:-1});const a=await models.article.count();i=i.map(e=>((e=JSON.parse(JSON.stringify(e))).create_time=r(e.create_time).format("YYYY-MM-DD HH:mm"),e)),e.body=n(!0,{list:i,count:a})},create:async e=>{const{body:t}=e.request,{title:o}=t;o?(await models.article.create(t),e.body=n(!0,"操作成功")):e.body=n(!1,"e001")}}},function(e,t,o){const n=o(0),r=o(12),s=n({prefix:"/api/article"});s.post("/list",r.list),s.post("/create",r.create),e.exports=s},function(e,t){e.exports=require("koa-busboy")},function(e,t){e.exports=require("node-schedule")},function(e,t){e.exports={e001:"请求参数缺失",e002:"服务器出错喽，请稍后重试",e003:"请求参数错误"}},function(e,t,o){const{getResponse:n}=o(1);e.exports={create:async e=>{const{path:t}=e.request.files[0];e.body=n(!0,{src:t})}}},function(e,t,o){const n=o(0),r=o(17),s=o(14)({dest:"xlt/upload",fnDestFilename:(e,t)=>Date.now().toString(16)+t}),i=n({prefix:"/api/uploadfile"});i.post("/",s,r.create),e.exports=i},function(e,t){const o=Number.parseInt(Object({NODE_ENV:"development"}).PORT)||6001,n="mongodb://root:306724680@118.24.26.149:3717";e.exports={port:o,mongoUri:n,mongoUriParam:"authSource=xlt",sessionURL:{url:n+"/?authSource=xlt&poolSize=5",db:"xlt",collection:"sessions",maxAge:86400}}},function(e,t,o){const n=o(2);e.exports={Index:async e=>{await e.render("index",{cdnHostName:n.cdnHostName,jsVersion:n.jsVersion})}}},function(e,t,o){const n=o(0),r=o(20),s=n();s.get("/",r.Index),e.exports=s},function(e,t,o){const n=o(0),r=o(21),s=o(18),i=o(13),a=o(11),c=n({prefix:"/xlt"}),u=[r,s,i,a];for(route of u)c.use(route.routes(),route.allowedMethods());e.exports=c},function(e,t){e.exports=require("koa2-cors")},function(e,t){e.exports=require("koa-session-mongo2")},function(e,t){e.exports=require("koa-session")},function(e,t){e.exports=require("koa-views")},function(e,t){e.exports=require("koa-logger")},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa")},function(e,t,o){(function(e){const t=o(29),n=o(28),r=o(27),s=o(26),i=o(25),a=o(24),c=o(23),u=o(22),d=o(2),l=new t;l.use(r()),l.use(c()),l.use(n({})),l.use(s(e+"/view",{map:{html:"lodash"}})),l.use(i({key:"koa_sess",store:new a(d.sessionURL),signed:!1,maxAge:864e5},l));const{SessStoreUser:p,LogFileArrange:f}=o(1);l.use(p),f(),l.use(u.routes(),u.allowedMethods()),global.models=o(8),l.listen(d.port)}).call(this,"src")},function(e,t,o){e.exports=o(30)}]);